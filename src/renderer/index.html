<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
  <title>Agent MG - Kreator Postaci (ES6 Modules)</title>
  <link rel="stylesheet" href="styles/theme.css">
  <link rel="stylesheet" href="styles/overlay.css">
</head>

<body>
  <div class="window-controls">
    <button class="win-btn" onclick="window.electronAPI.minimizeWindow()" title="Minimize">‚îÄ</button>
    <button class="win-btn" onclick="window.electronAPI.maximizeWindow()" title="Maximize">‚ñ°</button>
    <button class="win-btn close" onclick="window.electronAPI.closeWindow()" title="Close">‚úï</button>
  </div>
  <div id="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <span class="logo-icon">‚öîÔ∏è</span>
        <span class="logo-text">Agent MG</span>
      </div>

      <nav class="steps-nav">
        <div class="step-item" data-step="1">
          <span class="step-icon">üìÇ</span>
          <span class="step-label">≈πr√≥d≈Ço danych</span>
        </div>
        <div class="step-item" data-step="2">
          <span class="step-icon">‚ö°</span>
          <span class="step-label">Ekstrakcja</span>
        </div>
        <div class="step-item" data-step="3">
          <span class="step-icon">üß†</span>
          <span class="step-label">AI Processing</span>
        </div>

      </nav>

      <div class="sidebar-settings">
        <div class="step-item settings-item" data-step="settings" onclick="showSettings()">
          <span class="step-indicator">‚öôÔ∏è</span>
          <span class="step-label">Ustawienia AI</span>
        </div>
        <div class="step-item testbench-item" data-step="testbench" onclick="showTestbench()">
          <span class="step-indicator">üß™</span>
          <span class="step-label">Model Testbench</span>
        </div>
        <div class="step-item tests-item" data-step="tests" onclick="showAdvancedTests()">
          <span class="step-indicator">üìä</span>
          <span class="step-label">Advanced Tests</span>
        </div>
        <div class="step-item confighub-item" data-step="confighub" onclick="showConfigHub()">
          <span class="step-indicator">üîß</span>
          <span class="step-label">ConfigHub</span>
        </div>
        <div class="step-item graph-item" data-step="graph" onclick="window.AppModules.showGlobalGraph()">
          <span class="step-indicator">üï∏Ô∏è</span>
          <span class="step-label">Mapa Relacji</span>
        </div>
      </div>

      <div class="sidebar-footer">
        <div class="operator-widget" id="operatorWidget" onclick="openOperatorModal()"
          title="Kliknij, aby zmieniƒá Operatora">
          <div class="operator-icon">üë§</div>
          <div class="operator-info">
            <span class="operator-label">Operator</span>
            <span class="operator-name" id="currentOperatorName">Domy≈õlny</span>
          </div>
        </div>

        <div class="ollama-status" id="ollamaStatus">
          <span class="status-dot offline"></span>
          <span>Ollama: sprawdzam...</span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="content-header">
        <h1 id="stepTitle">Krok 1: ≈πr√≥d≈Ço danych</h1>
        <div class="trace-badge" id="traceBadge">
          Trace: <span id="traceId">---</span>
        </div>
      </header>

      <section class="content-body" id="stepContent">
        <!-- Step content loaded dynamically -->
        <div class="step-placeholder">
          <p>≈Åadowanie modu≈Ç√≥w ES6...</p>
        </div>
      </section>

      <footer class="content-footer">
        <div class="progress-section">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <span class="progress-text" id="progressText">Gotowy do pracy</span>
        </div>

        <div class="nav-buttons">
          <button class="btn btn-secondary" id="btnPrev" disabled>‚óÄ Wstecz</button>
          <button class="btn btn-primary" id="btnNext">Dalej ‚ñ∂</button>
        </div>
      </footer>
    </main>

    <!-- Log Panel (collapsible) -->
    <aside class="log-panel collapsed" id="logPanel">
      <div class="log-header">
        <span>Logi</span>
        <button class="btn-icon" id="btnToggleLogs">‚ñº</button>
      </div>
      <div class="log-content" id="logContent">
        <div class="log-entry log-info">
          <span class="log-time">--:--:--</span>
          <span class="log-msg">≈Åadowanie modu≈Ç√≥w ES6...</span>
        </div>
      </div>
    </aside>

    <!-- Global Prompt History Panel (Added via Fix) -->
    <div id="globalPromptHistoryPanel" style="display: none;">
      <div class="history-header">
        <span>üìú Historia Prompt√≥w</span>
        <button class="btn-icon" onclick="togglePromptHistory()">‚úï</button>
      </div>
      <div id="globalPromptHistoryContent" class="history-content">
        <!-- History items injected here -->
      </div>
    </div>

    <!-- AI PANEL STATIC SHELL TEMPLATE -->
    <template id="ai-panel-template">
      <!-- Top Section: Profile & Excel Search -->
      <div id="ai-panel-top-section" style="max-width: 900px; margin: 0 auto; padding: 0 32px; width: 100%;">
        <!-- Dynamic Profile Details Injected Here -->
        <div id="ai-profile-details"></div>

        <!-- Excel Search Panel -->
        <div class="card" id="excel-search-panel"
          style="margin-top: 20px; border-left: 2px solid var(--gold); padding: 12px 16px; background: rgba(0,0,0,0.2); display: none;">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
            <div
              style="display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: var(--gold-dim);">
              üîç PRZESZUKIWANIE PODSUMOWA≈É (EXCEL)
            </div>
            <div style="flex: 1; display: flex; gap: 10px; align-items: center; justify-content: flex-end;">
              <button class="btn btn-sm btn-primary" onclick="runExcelSearch()" id="btnExcelSearch"
                style="padding: 4px 12px; font-size: 12px;">
                üîé Szukaj wzmianek
              </button>
              <span id="excelSearchStatus" style="font-size: 11px; color: var(--text-dim);"></span>
            </div>
          </div>
          <div id="excelSearchResults" style="margin-top: 10px; display: none;"></div>
        </div>
      </div>

      <div class="ai-chat-layout">
        <!-- MESSAGES FEED -->
        <div class="ai-feed" id="aiFeedContainer">
          <!-- Dynamic Messages Injected Here -->
          <div id="ai-feed-content"></div>

          <!-- Loading Indicator (Hidden by default) -->
          <div id="ai-loading-indicator" class="ai-message bot" style="display: none;">
            <div class="ai-avatar">‚è≥</div>
            <div class="ai-message-content"
              style="color: var(--text-dim); display: flex; align-items: center; gap: 8px;">
              <span class="thinking-dots">My≈õlƒô</span>
              <span id="thinking-timer-display"
                style="font-size: 11px; opacity: 0.7; font-family: monospace;">(0.0s)</span>
            </div>
          </div>
        </div>

        <!-- BOTTOM INPUT AREA -->
        <div class="ai-input-container">
          <!-- Tool Chips Bar -->
          <div class="ai-tools-bar">
            <button class="ai-tool-chip" id="btn-quick-actions" onclick="toggleDropdown('quickActions')">
              ‚ö° Szybkie Akcje
            </button>
            <button class="ai-tool-chip" id="btn-model-select" onclick="toggleDropdown('model')">
              üß† Model
            </button>
            <button class="ai-tool-chip" id="btn-context-settings" onclick="toggleDropdown('context')">
              ‚öôÔ∏è Ustawienia
            </button>
            <button class="ai-tool-chip" onclick="window.AppModules.runCharacterTest()"
              style="border: 1px solid var(--gold); color: var(--gold);">
              üß™ Test Postaci
            </button>
          </div>

          <!-- Floating Menus Containers -->
          <div id="dropdown-quick-actions-container"></div>
          <div id="dropdown-model-container"></div>
          <div id="dropdown-context-container"></div>

          <!-- Main Input Box -->
          <div class="ai-input-box">
            <textarea class="ai-input-textarea" id="mainPromptInput"
              placeholder="Wpisz polecenie... (Enter aby wys≈Çaƒá, Shift+Enter nowa linia)" rows="1"></textarea>

            <button class="ai-send-btn" id="btn-send-prompt" title="Wy≈õlij wiadomo≈õƒá">
              ‚ñ∂
            </button>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- Legacy scripts (non-module) - loaded first -->
  <script src="testbench-history.js"></script>

  <script src="tests-panel.js"></script>
  <script src="confighub-panel.js"></script>
  <script src="chat-utils.js"></script>
  <script src="structured-card-renderer.js"></script>
  <script src="stream-helpers.js"></script>

  <!-- Main app.js (legacy) -->
  <script type="module" src="app.js"></script>
  <script src="conversation-flow-extension.js"></script>

  <!-- ES6 Modules (load after app.js for global function exposure) -->
  <script type="module">
    // Import all modules to expose functions globally
    import * as modules from './modules/index.js';

    // Expose to window for debugging and legacy compatibility
    window.AppModules = modules;
    console.log('‚úÖ ES6 Modules loaded:', Object.keys(modules).length, 'exports');
  </script>
</body>

</html>